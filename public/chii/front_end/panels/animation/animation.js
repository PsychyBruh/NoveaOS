import*as e from"../../ui/legacy/legacy.js";import*as t from"../../core/common/common.js";import*as i from"../../core/host/host.js";import*as n from"../../core/i18n/i18n.js";import*as a from"../../core/platform/platform.js";import*as s from"../../ui/legacy/components/inline_editor/inline_editor.js";import*as o from"../../core/sdk/sdk.js";const r=new CSSStyleSheet;r.replaceSync(':host{overflow:hidden;--timeline-controls-width:150px}.animation-node-row{width:100%;display:flex;border-bottom:1px dashed var(--sys-color-divider)}.animation-node-description{padding-left:8px;overflow:hidden;position:relative;background-color:var(--sys-color-cdt-base-container);display:flex;flex-direction:column;justify-content:space-around;align-items:flex-start;white-space:nowrap;flex:0 0 var(--timeline-controls-width)}.animation-node-description > *{flex:0 0 auto}.animation-timeline-row{height:32px;position:relative}path.animation-keyframe{fill-opacity:0.2}.animation-node-selected path.animation-keyframe,\nsvg.animation-ui g:first-child:hover path.animation-keyframe{fill-opacity:0.4}line.animation-line{stroke-width:2px;stroke-linecap:round;fill:none}line.animation-delay-line{stroke-width:2px;stroke-dasharray:6,4}line.animation-delay-line.animation-fill{stroke-dasharray:none}circle.animation-keyframe-point{fill:var(--sys-color-cdt-base-container)}circle.animation-endpoint,\ncircle.animation-keyframe-point{stroke-width:2px;transition:transform 100ms cubic-bezier(0,0,0.2,1);transform:scale(1);transform-box:fill-box;transform-origin:50% 50%}circle.animation-endpoint:active,\ncircle.animation-keyframe-point:active{transform:scale(1)}.animation-ui circle.animation-endpoint:hover,\n.animation-ui circle.animation-keyframe-point:hover{transform:scale(1.2)}.animation-name{position:absolute;top:8px;color:var(--sys-color-on-surface);text-align:center;margin-left:-8px;white-space:nowrap}.animation-timeline-toolbar-container{display:flex;background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider);flex:0 0 auto}.animation-timeline-toolbar{display:inline-block}.animation-timeline-header{height:28px;border-bottom:1px solid var(--sys-color-divider);flex-shrink:0;display:flex}.animation-timeline-header::after{content:"";height:calc(100% - 48px - 28px);position:absolute;width:var(--timeline-controls-width);left:0;margin-top:28px;background-color:var(--sys-color-cdt-base-container);z-index:0;border-right:1px solid var(--sys-color-divider)}.animation-controls{flex:0 0 var(--timeline-controls-width);position:relative;display:flex;justify-content:flex-end;padding-right:8px}.animation-timeline-current-time{flex:0 0 auto;line-height:28px;margin-right:5px}.animation-grid-header{flex:1 0 auto;z-index:2}.animation-grid-header.scrubber-enabled{cursor:pointer}.animation-timeline-buffer,\n.animation-timeline-buffer-hint{height:48px;flex:0 0 auto;border-bottom:1px solid var(--sys-color-divider);display:flex;padding:0 2px}.animation-timeline-buffer:empty,\n.animation-timeline-buffer-hint{display:none}.animation-timeline-buffer:empty ~ .animation-timeline-buffer-hint{align-items:center;justify-content:center;font-size:14px;z-index:101;display:flex}.animation-time-overlay{background-color:var(--sys-color-on-surface);opacity:5%;position:absolute;height:100%;width:100%;z-index:-1}.animation-timeline-end > .animation-time-overlay{visibility:hidden}.animation-scrubber{opacity:100%;position:absolute;left:10px;height:100%;width:100%;top:28px;border-left:1px solid var(--sys-color-error);z-index:2}.animation-scrubber-line{width:11px;background:linear-gradient(to right,transparent 5px,var(--sys-color-error) 5px,var(--sys-color-error) 6px,transparent 6px);position:absolute;top:-28px;height:28px;left:-6px;padding:0 5px;z-index:3}.animation-scrubber-head{width:7px;height:7px;transform:rotate(45deg);background:var(--sys-color-error);position:absolute;left:2px;top:1px;z-index:4}.grid-overflow-wrapper{position:absolute;left:calc(var(--timeline-controls-width) - 10px);top:76px;z-index:1;overflow:hidden;width:100%;height:100%}svg.animation-timeline-grid{position:absolute;left:0;top:0;right:0;bottom:0;width:100%;height:100%}rect.animation-timeline-grid-line{fill:var(--sys-color-divider)}.animation-timeline-row > svg.animation-ui{position:absolute}.animation-node-timeline{flex-grow:1}.animation-node-description > div{position:absolute;top:50%;transform:translateY(-50%);max-height:100%}.animation-node-removed{filter:saturate(0);cursor:not-allowed}.animation-node-removed-overlay{width:100%;height:100%;z-index:100;cursor:not-allowed}svg.animation-ui g:first-child{opacity:100%}svg.animation-ui circle:focus-visible,\nsvg.animation-ui path:focus-visible{outline:2px solid -webkit-focus-ring-color}.animation-tail-iterations{opacity:50%}.animation-keyframe-step line{stroke-width:2;stroke-opacity:0.3}text.animation-timeline-grid-label{font-size:10px;fill:var(--sys-color-token-subtle);text-anchor:middle}@keyframes --full-opacity-for-screenshots-container{from{opacity:100%}to{opacity:100%}}.preview-ui-container{position:relative;& .screenshot-arrow{background-image:var(--image-file-popoverArrows);background-position:0 76px;width:19px;height:19px;position:absolute;left:6px;top:-19px;z-index:100;pointer-events:none}& .screenshots-container{position:absolute;display:none;opacity:0%;left:6px;top:100%;z-index:100;border:1px solid transparent;box-shadow:var(--drop-shadow);border-radius:2px}& .screenshots-container.to-the-left{left:unset;right:6px}& .screenshots-container.to-the-left .screenshot-arrow{left:unset;right:6px}&:hover .screenshots-container:not(.no-screenshots){display:block;animation-name:--full-opacity-for-screenshots-container;animation-duration:0s;animation-delay:0.2s;animation-fill-mode:forwards}&:hover .screenshots-container:not(.no-screenshots):hover{display:none}}.animation-timeline-rows,\n.animation-timeline-rows-hint{flex-grow:1;overflow-y:auto;z-index:1;overflow-x:hidden}.animation-timeline-rows-hint{display:none}.animation-timeline-buffer:not(:empty) ~ .animation-timeline-rows:empty{flex-grow:0}.animation-timeline-buffer:not(:empty) ~ .animation-timeline-rows:empty ~ .animation-timeline-rows-hint{font-size:14px;display:flex;align-items:center;justify-content:center;margin-left:var(--timeline-controls-width);padding:10px}.toolbar.animation-controls-toolbar{flex:0 0 auto}.animation-node-row.animation-node-selected{background-color:var(--sys-color-state-ripple-primary)}.animation-node-selected > .animation-node-description{background-color:var(--sys-color-tonal-container)}.animation-buffer-preview{height:40px;margin:4px 2px;background-color:var(--sys-color-neutral-container);border:1px solid transparent;border-radius:2px;flex:1 1;padding:4px;max-width:100px;animation:newGroupAnim 200ms;position:relative}.animation-buffer-preview-animation{width:100%;height:100%;border-radius:2px 0 0 2px;position:absolute;top:0;left:0;background:var(--sys-color-tonal-container);opacity:0%;border-right:1px solid var(--sys-color-divider)}.animation-buffer-preview:focus-visible{outline:-webkit-focus-ring-color auto 5px}.animation-buffer-preview:not(.selected):focus-visible,\n.animation-buffer-preview:not(.selected):hover{background-color:var(--sys-color-surface-variant)}.animation-buffer-preview.selected{background-color:var(--sys-color-tonal-container)}.animation-paused{align-items:center;justify-content:center;display:none}.animation-paused::before,\n.animation-paused::after{content:"";background:var(--sys-color-cdt-base-container);width:7px;height:20px;border-radius:2px;margin:2px;border:1px solid var(--sys-color-divider)}.animation-buffer-preview.paused .animation-paused{display:flex}.animation-buffer-preview > svg > line{stroke-width:1px}.animation-buffer-preview.selected > svg > line{stroke:var(--sys-color-on-tonal-container)!important}@keyframes newGroupAnim{from{clip-path:polygon(0% 0%,0% 100%,50% 100%,50% 0%)}to{clip-path:polygon(0% 0%,0% 100%,100% 100%,100% 0%)}}.animation-playback-rate-control{margin:4px 0 4px 2px;display:flex;width:120px}.animation-playback-rate-button{border:1px solid var(--sys-color-tonal-outline);color:var(--sys-color-on-surface);display:inline-block;margin-right:-1px;padding:1px 4px;background-color:transparent;flex:1 0 auto;text-align:center}.animation-playback-rate-button:first-child{border-radius:4px 0 0 4px}.animation-playback-rate-button:last-child{border-radius:0 4px 4px 0}.animation-playback-rate-button.selected{color:var(--sys-color-on-tonal-container);background-color:var(--sys-color-tonal-container);border-color:var(--sys-color-tonal-container);z-index:1}.animation-playback-rate-button.selected:focus-visible{color:var(--sys-color-on-surface)}.animation-playback-rate-button:focus-visible{outline:2px solid var(--sys-color-primary);outline-offset:2px}.animation-playback-rate-button:not(.selected):hover{background:var(--sys-color-state-hover-on-subtle)}.animation-remove-button{position:absolute;top:-3px;right:-3px;background:var(--sys-color-token-subtle);border-radius:12px;height:16px;width:16px;align-items:center;font-size:10px;justify-content:center;z-index:100;display:none;font-weight:700;color:var(--sys-color-cdt-base-container)}.animation-remove-button:hover{background:var(--sys-color-on-surface)}.animation-buffer-preview:hover .animation-remove-button{display:flex}.timeline-controls-resizer{position:absolute;width:6px;height:100%;left:var(--timeline-controls-width);top:104px;z-index:3;margin-left:-4px}@media (forced-colors: active){.animation-playback-rate-button.selected,\n  .animation-playback-rate-button.selected:first-child,\n  .animation-playback-rate-button.selected:first-child:focus-visible,\n  .animation-playback-rate-button:focus-visible{forced-color-adjust:none;color:HighlightText;background-color:Highlight}.animation-node-description:focus-visible{background-color:var(--sys-color-cdt-base-container);forced-color-adjust:none}.monospace{forced-color-adjust:auto}}\n/*# sourceURL=animationTimeline.css */\n');class l extends o.SDKModel.SDKModel{runtimeModel;agent;#e;animationGroups;#t;playbackRate;#i;#n;constructor(e){super(e),this.runtimeModel=e.model(o.RuntimeModel.RuntimeModel),this.agent=e.animationAgent(),e.registerAnimationDispatcher(new f(this)),this.#e=new Map,this.animationGroups=new Map,this.#t=new Set,this.playbackRate=1;e.model(o.ResourceTreeModel.ResourceTreeModel).addEventListener(o.ResourceTreeModel.Events.PrimaryPageChanged,this.reset,this);const t=e.model(o.ScreenCaptureModel.ScreenCaptureModel);t&&(this.#i=new b(this,t))}reset(){this.#e.clear(),this.animationGroups.clear(),this.#t.clear(),this.dispatchEventToListeners(d.ModelReset)}animationCreated(e){this.#t.add(e)}animationCanceled(e){this.#t.delete(e),this.flushPendingAnimationsIfNeeded()}animationStarted(e){if(!e.source||!e.source.backendNodeId)return;const t=h.parsePayload(this,e);if(!t)return;const i=t.source().keyframesRule();"WebAnimation"===t.type()&&i&&0===i.keyframes().length?this.#t.delete(t.id()):(this.#e.set(t.id(),t),this.#t.add(t.id())),this.flushPendingAnimationsIfNeeded()}flushPendingAnimationsIfNeeded(){for(const e of this.#t)if(!this.#e.get(e))return;for(;this.#t.size;)this.matchExistingGroups(this.createGroupFromPendingAnimations())}matchExistingGroups(e){let t=null;for(const i of this.animationGroups.values())if(i.matches(e)){t=i,i.update(e);break}return t||(this.animationGroups.set(e.id(),e),this.#i&&this.#i.captureScreenshots(e.finiteDuration(),e.screenshotsInternal)),this.dispatchEventToListeners(d.AnimationGroupStarted,t||e),Boolean(t)}createGroupFromPendingAnimations(){console.assert(this.#t.size>0);const e=this.#t.values().next().value;this.#t.delete(e);const t=this.#e.get(e);if(!t)throw new Error("Unable to locate first animation");const i=[t],n=t.startTime(),a=new Set;for(const e of this.#t){const t=this.#e.get(e);t.startTime()===n?i.push(t):a.add(e)}return this.#t=a,new p(this,e,i)}setPlaybackRate(e){this.playbackRate=e,this.agent.invoke_setPlaybackRate({playbackRate:e})}releaseAnimations(e){this.agent.invoke_releaseAnimations({animations:e})}async suspendModel(){this.reset(),await this.agent.invoke_disable()}async resumeModel(){this.#n&&await this.agent.invoke_enable()}async ensureEnabled(){this.#n||(await this.agent.invoke_enable(),this.#n=!0)}}var d;!function(e){e.AnimationGroupStarted="AnimationGroupStarted",e.ModelReset="ModelReset"}(d||(d={}));class h{#a;#s;#o;#r;constructor(e,t){this.#a=e,this.#s=t,this.#o=new c(e,this.#s.source)}static parsePayload(e,t){return new h(e,t)}payload(){return this.#s}id(){return this.#s.id}name(){return this.#s.name}paused(){return this.#s.pausedState}playState(){return this.#r||this.#s.playState}setPlayState(e){this.#r=e}playbackRate(){return this.#s.playbackRate}startTime(){return this.#s.startTime}endTime(){return this.source().iterations?this.startTime()+this.source().delay()+this.source().duration()*this.source().iterations()+this.source().endDelay():1/0}finiteDuration(){const e=Math.min(this.source().iterations(),3);return this.source().delay()+this.source().duration()*e}currentTime(){return this.#s.currentTime}source(){return this.#o}type(){return this.#s.type}overlaps(e){if(!this.source().iterations()||!e.source().iterations())return!0;const t=this.startTime()<e.startTime()?this:e,i=t===this?e:this;return t.endTime()>=i.startTime()}setTiming(e,t){this.#o.node().then((i=>{if(!i)throw new Error("Unable to find node");this.updateNodeStyle(e,t,i)})),this.#o.durationInternal=e,this.#o.delayInternal=t,this.#a.agent.invoke_setTiming({animationId:this.id(),duration:e,delay:t})}updateNodeStyle(e,t,i){let n;if("CSSTransition"===this.type())n="transition-";else{if("CSSAnimation"!==this.type())return;n="animation-"}if(!i.id)throw new Error("Node has no id");const a=i.domModel().cssModel();a.setEffectivePropertyValueForNode(i.id,n+"duration",e+"ms"),a.setEffectivePropertyValueForNode(i.id,n+"delay",t+"ms")}async remoteObjectPromise(){const e=await this.#a.agent.invoke_resolveAnimation({animationId:this.id()});return e?this.#a.runtimeModel.createRemoteObject(e.remoteObject):null}cssId(){return this.#s.cssId||""}}class c{#a;#l;#d;delayInternal;durationInternal;#h;constructor(e,t){this.#a=e,this.#l=t,t.keyframesRule&&(this.#d=new m(t.keyframesRule)),this.delayInternal=this.#l.delay,this.durationInternal=this.#l.duration}delay(){return this.delayInternal}endDelay(){return this.#l.endDelay}iterationStart(){return this.#l.iterationStart}iterations(){return this.delay()||this.endDelay()||this.duration()?this.#l.iterations||1/0:0}duration(){return this.durationInternal}direction(){return this.#l.direction}fill(){return this.#l.fill}node(){return this.#h||(this.#h=new o.DOMModel.DeferredDOMNode(this.#a.target(),this.backendNodeId())),this.#h.resolvePromise()}deferredNode(){return new o.DOMModel.DeferredDOMNode(this.#a.target(),this.backendNodeId())}backendNodeId(){return this.#l.backendNodeId}keyframesRule(){return this.#d||null}easing(){return this.#l.easing}}class m{#l;#c;constructor(e){this.#l=e,this.#c=this.#l.keyframes.map((function(e){return new u(e)}))}setKeyframesPayload(e){this.#c=e.map((function(e){return new u(e)}))}name(){return this.#l.name}keyframes(){return this.#c}}class u{#l;#m;constructor(e){this.#l=e,this.#m=this.#l.offset}offset(){return this.#m}setOffset(e){this.#m=100*e+"%"}offsetAsNumber(){return parseFloat(this.#m)/100}easing(){return this.#l.easing}}class p{#a;#u;#p;#f;screenshotsInternal;#b;constructor(e,t,i){this.#a=e,this.#u=t,this.#p=i,this.#f=!1,this.screenshotsInternal=[],this.#b=[]}id(){return this.#u}animations(){return this.#p}release(){this.#a.animationGroups.delete(this.id()),this.#a.releaseAnimations(this.animationIds())}animationIds(){return this.#p.map((function(e){return e.id()}))}startTime(){return this.#p[0].startTime()}finiteDuration(){let e=0;for(let t=0;t<this.#p.length;++t)e=Math.max(e,this.#p[t].finiteDuration());return e}seekTo(e){this.#a.agent.invoke_seekAnimations({animations:this.animationIds(),currentTime:e})}paused(){return this.#f}togglePause(e){e!==this.#f&&(this.#f=e,this.#a.agent.invoke_setPaused({animations:this.animationIds(),paused:e}))}currentTimePromise(){let e=null;for(const t of this.#p)(!e||t.endTime()>e.endTime())&&(e=t);if(!e)throw new Error("No longest animation found");return this.#a.agent.invoke_getCurrentTime({id:e.id()}).then((({currentTime:e})=>e||0))}matches(e){function t(e){return"WebAnimation"===e.type()?e.type()+e.id():e.cssId()}if(this.#p.length!==e.#p.length)return!1;const i=this.#p.map(t).sort(),n=e.#p.map(t).sort();for(let e=0;e<i.length;e++)if(i[e]!==n[e])return!1;return!0}update(e){this.#a.releaseAnimations(this.animationIds()),this.#p=e.#p}screenshots(){for(let e=0;e<this.screenshotsInternal.length;++e){const t=new Image;t.src="data:image/jpeg;base64,"+this.screenshotsInternal[e],this.#b.push(t)}return this.screenshotsInternal=[],this.#b}}class f{#a;constructor(e){this.#a=e}animationCreated({id:e}){this.#a.animationCreated(e)}animationCanceled({id:e}){this.#a.animationCanceled(e)}animationStarted({animation:e}){this.#a.animationStarted(e)}}class b{#y;#g;#a;#v;#w;#x;constructor(e,t){this.#y=[],this.#g=t,this.#a=e,this.#a.addEventListener(d.ModelReset,this.stopScreencast,this)}captureScreenshots(e,t){const i=Math.min(e/this.#a.playbackRate,3e3),n=i+window.performance.now();this.#y.push({endTime:n,screenshots:t}),(!this.#w||n>this.#w)&&(clearTimeout(this.#v),this.#v=window.setTimeout(this.stopScreencast.bind(this),i),this.#w=n),this.#x||(this.#x=!0,this.#g.startScreencast("jpeg",80,void 0,300,2,this.screencastFrame.bind(this),(e=>{})))}screencastFrame(e,t){if(!this.#x)return;const i=window.performance.now();this.#y=this.#y.filter((function(e){return e.endTime>=i}));for(const t of this.#y)t.screenshots.push(e)}stopScreencast(){this.#x&&(this.#v=void 0,this.#w=void 0,this.#y=[],this.#x=!1,this.#g.stopScreencast())}}o.SDKModel.SDKModel.register(l,{capabilities:o.Target.Capability.DOM,autostart:!1});var y=Object.freeze({__proto__:null,AnimationModel:l,get Events(){return d},AnimationImpl:h,AnimationEffect:c,KeyframesRule:m,KeyframeStyle:u,AnimationGroup:p,AnimationDispatcher:f,ScreenshotCapture:b});const g=new CSSStyleSheet;g.replaceSync("img{max-height:300px;border-radius:2px}.animation-progress{position:absolute;height:2px;bottom:0;left:0;background:var(--legacy-selection-bg-color)}\n/*# sourceURL=animationScreenshotPopover.css */\n");class v extends e.Widget.VBox{#M;#k;#A;#I;#T;#C;constructor(e){super(!0),console.assert(e.length>0),this.contentElement.classList.add("animation-screenshot-popover"),this.#M=e;for(const t of e)this.contentElement.appendChild(t),t.style.display="none";this.#k=0,this.#A=0,this.#M[0].style.display="block",this.#I=this.contentElement.createChild("div","animation-progress")}wasShown(){this.#k=this.contentElement.window().requestAnimationFrame(this.changeFrame.bind(this)),this.registerCSSFiles([g])}willHide(){this.contentElement.window().cancelAnimationFrame(this.#k),this.#C=void 0}changeFrame(){if(this.#k=this.contentElement.window().requestAnimationFrame(this.changeFrame.bind(this)),this.#C)return void this.#C--;if(this.#T=!this.#T,!this.#T)return;const e=this.#M.length;this.#M[this.#A%e].style.display="none",this.#A++,this.#M[this.#A%e].style.display="block",this.#A%e==e-1&&(this.#C=50),this.#I.style.width=(this.#A%e+1)/e*100+"%"}}var w=Object.freeze({__proto__:null,AnimationScreenshotPopover:v});const x={selectAnEffectAboveToInspectAnd:"Select an effect above to inspect and modify.",clearAll:"Clear all",pauseAll:"Pause all",playbackRates:"Playback rates",playbackRatePlaceholder:"{PH1}%",pause:"Pause",setSpeedToS:"Set speed to {PH1}",animationPreviews:"Animation previews",waitingForAnimations:"Waiting for animations...",replayTimeline:"Replay timeline",resumeAll:"Resume all",playTimeline:"Play timeline",pauseTimeline:"Pause timeline",animationPreviewS:"Animation Preview {PH1}"},M=n.i18n.registerUIStrings("panels/animation/AnimationTimeline.ts",x),k=n.i18n.getLocalizedString.bind(void 0,M),A=new WeakMap,I=new WeakMap;let T;class C extends e.Widget.VBox{#S;#P;#R;#E;#B=[];#G;#L;#D;#U;#F;#N;#z;#O;#H;#_;#j;#K;#V;#W;#X;#q;#Q;#$;#Y;#Z;#J;#ee;#te;#ie;#ne;#ae;#se;#oe;#re;constructor(){super(!0),this.element.classList.add("animations-timeline"),this.#oe=this.contentElement.createChild("div","timeline-controls-resizer"),this.#S=this.contentElement.createChild("div","grid-overflow-wrapper"),this.#P=e.UIUtils.createSVGChild(this.#S,"svg","animation-timeline-grid"),this.#R=1,this.#E=!1,this.#ae=!1,this.createHeader(),this.#G=this.contentElement.createChild("div","animation-timeline-rows");this.contentElement.createChild("div","animation-timeline-rows-hint").textContent=k(x.selectAnEffectAboveToInspectAnd),this.#H=100,this.#_=this.#H,this.#K=new Map,this.#V=[],this.#W=[],this.#X=new Map,this.#q=new Map,this.#j=150,this.element.style.setProperty("--timeline-controls-width",`${this.#j}px`),o.TargetManager.TargetManager.instance().addModelListener(o.DOMModel.DOMModel,o.DOMModel.Events.NodeRemoved,(e=>this.markNodeAsRemoved(e.data.node)),this,{scoped:!0}),o.TargetManager.TargetManager.instance().observeModels(l,this,{scoped:!0}),e.Context.Context.instance().addFlavorChangeListener(o.DOMModel.DOMNode,this.nodeChanged,this),this.#le()}static instance(e){return T&&!e?.forceNew||(T=new C),T}#le(){let t;e.UIUtils.installDragHandle(this.#oe,(e=>(t=e.clientX,!0)),(e=>{if(void 0===t)return;const i=this.#j+e.clientX-t;this.#j=Math.min(Math.max(i,120),720),t=e.clientX,this.element.style.setProperty("--timeline-controls-width",this.#j+"px"),this.onResize()}),(()=>{t=void 0}),"ew-resize")}get previewMap(){return this.#X}get uiAnimations(){return this.#V}get groupBuffer(){return this.#W}wasShown(){for(const e of o.TargetManager.TargetManager.instance().models(l,{scoped:!0}))this.addEventListeners(e);this.registerCSSFiles([r])}willHide(){for(const e of o.TargetManager.TargetManager.instance().models(l,{scoped:!0}))this.removeEventListeners(e)}modelAdded(e){this.isShowing()&&this.addEventListeners(e)}modelRemoved(e){this.removeEventListeners(e)}addEventListeners(e){e.ensureEnabled(),e.addEventListener(d.AnimationGroupStarted,this.animationGroupStarted,this),e.addEventListener(d.ModelReset,this.reset,this)}removeEventListeners(e){e.removeEventListener(d.AnimationGroupStarted,this.animationGroupStarted,this),e.removeEventListener(d.ModelReset,this.reset,this)}nodeChanged(){for(const e of this.#K.values())e.nodeChanged()}createScrubber(){return this.#U=document.createElement("div"),this.#U.classList.add("animation-scrubber"),this.#U.classList.add("hidden"),this.#Q=this.#U.createChild("div","animation-scrubber-line"),this.#Q.createChild("div","animation-scrubber-head"),this.#U.createChild("div","animation-time-overlay"),this.#U}createHeader(){const t=this.contentElement.createChild("div","animation-timeline-toolbar-container"),n=new e.Toolbar.Toolbar("animation-timeline-toolbar",t);this.#N=new e.Toolbar.ToolbarButton(k(x.clearAll),"clear"),this.#N.addEventListener(e.Toolbar.ToolbarButton.Events.Click,(()=>{i.userMetrics.actionTaken(i.UserMetrics.Action.AnimationGroupsCleared),this.reset()})),n.appendToolbarItem(this.#N),n.appendSeparator(),this.#$=new e.Toolbar.ToolbarToggle(k(x.pauseAll),"pause","resume"),this.#$.addEventListener(e.Toolbar.ToolbarButton.Events.Click,(()=>{this.togglePauseAll()})),n.appendToolbarItem(this.#$);const a=t.createChild("div","animation-playback-rate-control");a.addEventListener("keydown",this.handlePlaybackRateControlKeyDown.bind(this)),e.ARIAUtils.markAsListBox(a),e.ARIAUtils.setLabel(a,k(x.playbackRates)),this.#L=[];for(const t of S){const i=a.createChild("button","animation-playback-rate-button");i.textContent=t?k(x.playbackRatePlaceholder,{PH1:100*t}):k(x.pause),I.set(i,t),i.addEventListener("click",this.setPlaybackRate.bind(this,t)),e.ARIAUtils.markAsOption(i),e.Tooltip.Tooltip.install(i,k(x.setSpeedToS,{PH1:i.textContent})),i.tabIndex=-1,this.#L.push(i)}this.updatePlaybackControls(),this.#D=this.contentElement.createChild("div","animation-timeline-buffer"),e.ARIAUtils.markAsListBox(this.#D),e.ARIAUtils.setLabel(this.#D,k(x.animationPreviews));this.contentElement.createChild("div","animation-timeline-buffer-hint").textContent=k(x.waitingForAnimations);const s=this.contentElement.createChild("div","animation-timeline-header"),o=s.createChild("div","animation-controls");this.#F=o.createChild("div","animation-timeline-current-time monospace");const r=new e.Toolbar.Toolbar("animation-controls-toolbar",o);return this.#Y=new e.Toolbar.ToolbarToggle(k(x.replayTimeline),"replay"),this.#Z="replay-outline",this.#Y.setToggled(!0),this.#Y.addEventListener(e.Toolbar.ToolbarButton.Events.Click,this.controlButtonToggle.bind(this)),r.appendToolbarItem(this.#Y),this.#re=s.createChild("div","animation-grid-header"),e.UIUtils.installDragHandle(this.#re,this.scrubberDragStart.bind(this),this.scrubberDragMove.bind(this),this.scrubberDragEnd.bind(this),null),this.#S.appendChild(this.createScrubber()),this.#F.textContent="",s}handlePlaybackRateControlKeyDown(e){switch(e.key){case"ArrowLeft":case"ArrowUp":this.focusNextPlaybackRateButton(e.target,!0);break;case"ArrowRight":case"ArrowDown":this.focusNextPlaybackRateButton(e.target)}}focusNextPlaybackRateButton(e,t){const i=e,n=this.#L.indexOf(i),a=t?n-1:n+1;if(a<0||a>=this.#L.length)return;const s=this.#L[a];s.tabIndex=0,s.focus(),e&&(e.tabIndex=-1)}togglePauseAll(){this.#E=!this.#E,i.userMetrics.actionTaken(this.#E?i.UserMetrics.Action.AnimationsPaused:i.UserMetrics.Action.AnimationsResumed),this.#$&&this.#$.setToggled(this.#E),this.setPlaybackRate(this.#R),this.#$&&this.#$.setTitle(this.#E?k(x.resumeAll):k(x.pauseAll))}setPlaybackRate(e){e!==this.#R&&i.userMetrics.animationPlaybackRateChanged(.1===e?2:.25===e?1:1===e?0:3),this.#R=e;for(const e of o.TargetManager.TargetManager.instance().models(l,{scoped:!0}))e.setPlaybackRate(this.#E?0:this.#R);i.userMetrics.actionTaken(i.UserMetrics.Action.AnimationsPlaybackRateChanged),this.#te&&(this.#te.playbackRate=this.effectivePlaybackRate()),this.updatePlaybackControls()}updatePlaybackControls(){for(const e of this.#L){const t=this.#R===I.get(e);e.classList.toggle("selected",t),e.tabIndex=t?0:-1}}controlButtonToggle(){"play-outline"===this.#Z?this.togglePause(!1):"replay-outline"===this.#Z?(i.userMetrics.actionTaken(i.UserMetrics.Action.AnimationGroupReplayed),this.replay()):this.togglePause(!0)}updateControlButton(){this.#Y&&(this.#Y.setEnabled(Boolean(this.#z)&&this.hasAnimationGroupActiveNodes()),this.#z&&this.#z.paused()?(this.#Z="play-outline",this.#Y.setToggled(!0),this.#Y.setTitle(k(x.playTimeline)),this.#Y.setGlyph("play")):!this.#te||!this.#te.currentTime||"number"!=typeof this.#te.currentTime||this.#te.currentTime>=this.duration()?(this.#Z="replay-outline",this.#Y.setToggled(!0),this.#Y.setTitle(k(x.replayTimeline)),this.#Y.setGlyph("replay")):(this.#Z="pause-outline",this.#Y.setToggled(!1),this.#Y.setTitle(k(x.pauseTimeline)),this.#Y.setGlyph("pause")))}effectivePlaybackRate(){return this.#E||this.#z&&this.#z.paused()?0:this.#R}togglePause(e){if(this.#z){this.#z.togglePause(e);const t=this.#X.get(this.#z);t&&t.element.classList.toggle("paused",e)}this.#te&&(this.#te.playbackRate=this.effectivePlaybackRate()),this.updateControlButton()}replay(){this.#z&&this.hasAnimationGroupActiveNodes()&&(this.#z.seekTo(0),this.animateTime(0),this.updateControlButton())}duration(){return this.#_}setDuration(e){this.#_=e,this.scheduleRedraw()}clearTimeline(){this.#V=[],this.#K.clear(),this.#q.clear(),this.#G.removeChildren(),this.#_=this.#H,this.#U.classList.add("hidden"),this.#re.classList.remove("scrubber-enabled"),this.#z=null,this.#te&&this.#te.cancel(),this.#te=void 0,this.#F.textContent="",this.updateControlButton()}reset(){this.clearTimeline(),this.setPlaybackRate(this.#R);for(const e of this.#W)e.release();this.#W=[],this.clearPreviews(),this.renderGrid()}animationGroupStarted({data:e}){this.addAnimationGroup(e)}clearPreviews(){this.#X.clear(),this.#B.forEach((e=>{e.detach()})),this.#D.removeChildren(),this.#B=[]}createPreview(t){const i=new z(t),n=document.createElement("div");n.classList.add("preview-ui-container"),n.appendChild(i.element);const a=document.createElement("div");if(a.classList.add("screenshots-container","no-screenshots"),a.createChild("span","screenshot-arrow"),a.addEventListener("animationend",(()=>{const{right:e}=a.getBoundingClientRect();e>window.innerWidth&&a.classList.add("to-the-left")})),n.appendChild(a),this.#W.push(t),this.#X.set(t,i),this.#D.appendChild(n),i.removeButton().addEventListener("click",this.removeAnimationGroup.bind(this,t)),i.element.addEventListener("click",this.selectAnimationGroup.bind(this,t)),i.element.addEventListener("keydown",this.handleAnimationGroupKeyDown.bind(this,t)),i.element.addEventListener("mouseover",(()=>{const e=t.screenshots();if(!e.length)return;a.classList.remove("no-screenshots");const i=()=>{const t=new v(e);this.#B.push(t),t.show(a)};e[0].complete?i():e[0].onload=i}),{once:!0}),e.ARIAUtils.setLabel(i.element,k(x.animationPreviewS,{PH1:this.#W.indexOf(t)+1})),e.ARIAUtils.markAsOption(i.element),1===this.#X.size){const e=this.#X.get(this.#W[0]);e&&(e.element.tabIndex=0)}}addAnimationGroup(e){const t=this.#X.get(e);if(t)return void(this.#z===e?this.syncScrubber():t.replay());this.#W.sort((function(e,t){return e.startTime()===t.startTime()?0:e.startTime()>t.startTime()?1:-1}));const i=[],n=this.width()/50;for(;this.#W.length>n;){const e=this.#W.splice(this.#W[0]===this.#z?1:0,1);i.push(e[0])}for(const e of i){const t=this.#X.get(e);t&&(t.element.remove(),this.#X.delete(e),e.release())}this.createPreview(e)}handleAnimationGroupKeyDown(e,t){switch(t.key){case" ":case"Enter":this.selectAnimationGroup(e);break;case"Backspace":case"Delete":this.removeAnimationGroup(e,t);break;case"ArrowLeft":case"ArrowUp":this.focusNextGroup(e,t.target,!0);break;case"ArrowRight":case"ArrowDown":this.focusNextGroup(e,t.target)}}focusNextGroup(e,t,i){const n=this.#W.indexOf(e),a=i?n-1:n+1;if(a<0||a>=this.#W.length)return;const s=this.#X.get(this.#W[a]);s&&(s.element.tabIndex=0,s.element.focus()),t&&(t.tabIndex=-1)}removeAnimationGroup(e,t){const i=this.#W.indexOf(e);a.ArrayUtilities.removeElement(this.#W,e);const n=this.#X.get(e);n&&n.element.remove(),this.#X.delete(e),e.release(),t.consume(!0),this.#z===e&&(this.clearTimeline(),this.renderGrid());if(0===this.#W.length)return void this.#N.element.focus();const s=i>=this.#W.length?this.#X.get(this.#W[this.#W.length-1]):this.#X.get(this.#W[i]);s&&(s.element.tabIndex=0,s.element.focus())}async selectAnimationGroup(e){if(this.#z===e)return this.togglePause(!1),void this.replay();this.clearTimeline(),this.#z=e,this.#X.forEach(((e,t)=>{e.element.classList.toggle("selected",this.#z===t)})),this.setDuration(Math.max(500,e.finiteDuration()+100)),await Promise.all(e.animations().map((e=>this.addAnimation(e)))),this.scheduleRedraw(),this.togglePause(!1),this.replay(),this.hasAnimationGroupActiveNodes()&&(this.#U.classList.remove("hidden"),this.#re.classList.add("scrubber-enabled")),this.animationGroupSelectedForTest()}animationGroupSelectedForTest(){}async addAnimation(e){let t=this.#K.get(e.source().backendNodeId());t||(t=new P(e.source()),this.#G.appendChild(t.element),this.#K.set(e.source().backendNodeId(),t));const i=t.createNewRow(),n=new D(e,this,i),a=await e.source().deferredNode().resolvePromise();n.setNode(a),a&&t&&(t.nodeResolved(a),A.set(a,t)),this.#V.push(n),this.#q.set(e.id(),e)}markNodeAsRemoved(e){A.get(e)?.nodeRemoved();for(const t of e.pseudoElements().values())t.forEach((e=>this.markNodeAsRemoved(e)));e.children()?.forEach((e=>{this.markNodeAsRemoved(e)})),this.hasAnimationGroupActiveNodes()||(this.#re.classList.remove("scrubber-enabled"),this.#U.classList.add("hidden"),this.#te?.cancel(),this.#te=void 0,this.#F.textContent="",this.updateControlButton())}hasAnimationGroupActiveNodes(){for(const e of this.#K.values())if(e.hasActiveNode())return!0;return!1}renderGrid(){let t;this.#P.removeChildren();for(let t=0;t<this.duration();t+=250){const i=e.UIUtils.createSVGChild(this.#P,"rect","animation-timeline-grid-line");i.setAttribute("x",(t*this.pixelMsRatio()+10).toString()),i.setAttribute("y","23"),i.setAttribute("height","100%"),i.setAttribute("width","1")}for(let i=0;i<this.duration();i+=250){const a=i*this.pixelMsRatio();if(void 0===t||a-t>50){t=a;const s=e.UIUtils.createSVGChild(this.#P,"text","animation-timeline-grid-label");s.textContent=n.TimeUtilities.millisToString(i),s.setAttribute("x",(a+10).toString()),s.setAttribute("y","16")}}}scheduleRedraw(){this.#O=[];for(const e of this.#V)this.#O.push(e);this.#J||(this.#J=!0,this.renderGrid(),this.#G.window().requestAnimationFrame(this.render.bind(this)))}render(e){for(;this.#O.length&&(!e||window.performance.now()-e<50);){const e=this.#O.shift();e&&e.redraw()}this.#O.length?this.#G.window().requestAnimationFrame(this.render.bind(this)):this.#J=void 0}onResize(){this.#ee=Math.max(0,this.#G.offsetWidth-this.#j)||0,this.scheduleRedraw(),this.#te&&this.syncScrubber(),this.#ie=void 0}width(){return this.#ee||0}syncScrubber(){this.#z&&this.hasAnimationGroupActiveNodes()&&this.#z.currentTimePromise().then(this.animateTime.bind(this)).then(this.updateControlButton.bind(this))}animateTime(e){this.#te&&this.#te.cancel(),this.#te=this.#U.animate([{transform:"translateX(0px)"},{transform:"translateX("+this.width()+"px)"}],{duration:this.duration(),fill:"forwards"}),this.#te.playbackRate=this.effectivePlaybackRate(),this.#te.onfinish=this.updateControlButton.bind(this),this.#te.currentTime=e,this.element.window().requestAnimationFrame(this.updateScrubber.bind(this))}pixelMsRatio(){return this.width()/this.duration()||0}updateScrubber(e){this.#te&&(this.#F.textContent=n.TimeUtilities.millisToString(this.#de()),"pending"===this.#te.playState.toString()||"running"===this.#te.playState?this.element.window().requestAnimationFrame(this.updateScrubber.bind(this)):"finished"===this.#te.playState&&(this.#F.textContent=""))}scrubberDragStart(e){if(!this.#z||!this.hasAnimationGroupActiveNodes())return!1;this.#ie||(this.#ie=this.#P.getBoundingClientRect().left+10);const t=this.#te?.currentTime;this.#ae=this.#z.paused()||"number"==typeof t&&t>=this.duration();const{x:i}=e,n=Math.max(0,i-this.#ie)/this.pixelMsRatio();return this.#z.seekTo(n),this.togglePause(!0),this.animateTime(n),this.#ne=n,this.#se=i,!0}scrubberDragMove(e){const{x:t}=e,i=t-(this.#se||0),a=Math.max(0,Math.min((this.#ne||0)+i/this.pixelMsRatio(),this.duration()));this.#te&&(this.#te.currentTime=a),this.#F.textContent=n.TimeUtilities.millisToString(Math.round(a)),this.#z&&this.#z.seekTo(a)}#de(){return"number"==typeof this.#te?.currentTime?this.#te.currentTime:0}scrubberDragEnd(e){if(this.#te){const e=Math.max(0,this.#de());this.#te.play(),this.#te.currentTime=e}i.userMetrics.actionTaken(i.UserMetrics.Action.AnimationGroupScrubbed),this.#F.window().requestAnimationFrame(this.updateScrubber.bind(this)),this.#ae||this.togglePause(!1)}}const S=[1,.25,.1];class P{element;#he;#ce;#me;#ue;constructor(t){this.element=document.createElement("div"),this.element.classList.add("animation-node-row"),this.#he=this.element.createChild("div","animation-node-description"),this.#ce=this.element.createChild("div","animation-node-timeline"),e.ARIAUtils.markAsApplication(this.#ce)}nodeResolved(n){n?(this.#ue=n,this.nodeChanged(),t.Linkifier.Linkifier.linkify(n).then((e=>{e.addEventListener("click",(()=>{i.userMetrics.actionTaken(i.UserMetrics.Action.AnimatedNodeDescriptionClicked)})),this.#he.appendChild(e)})),n.ownerDocument||this.nodeRemoved()):e.UIUtils.createTextChild(this.#he,"<node>")}createNewRow(){return this.#ce.createChild("div","animation-timeline-row")}nodeRemoved(){this.element.classList.add("animation-node-removed"),this.#me||(this.#me=document.createElement("div"),this.#me.classList.add("animation-node-removed-overlay"),this.#he.appendChild(this.#me)),this.#ue=null}hasActiveNode(){return Boolean(this.#ue)}nodeChanged(){let t=!1;this.#ue&&(t=this.#ue===e.Context.Context.instance().flavor(o.DOMModel.DOMNode)),this.element.classList.toggle("animation-node-selected",t)}}class R{steps;stepAtPosition;constructor(e,t){this.steps=e,this.stepAtPosition=t}static parse(e){let t=e.match(/^steps\((\d+), (start|middle)\)$/);return t?new R(parseInt(t[1],10),t[2]):(t=e.match(/^steps\((\d+)\)$/),t?new R(parseInt(t[1],10),"end"):null)}}var E=Object.freeze({__proto__:null,AnimationTimeline:C,GlobalPlaybackRates:S,NodeUI:P,StepTimingFunction:R});const B={animationEndpointSlider:"Animation Endpoint slider",animationKeyframeSlider:"Animation Keyframe slider",sSlider:"{PH1} slider"},G=n.i18n.registerUIStrings("panels/animation/AnimationUI.ts",B),L=n.i18n.getLocalizedString.bind(void 0,G);class D{#pe;#fe;#be;#ye;#ge;#ve;#we;#xe;#Me;#ke;#ue;#Ae;#Ie;#Te;#Ce;#Se;#Pe;constructor(t,i,n){this.#pe=t,this.#fe=i;const a=this.#pe.source().keyframesRule();a&&(this.#be=a.keyframes()),this.#ye=n.createChild("div","animation-name"),this.#ye.textContent=this.#pe.name(),this.#ge=e.UIUtils.createSVGChild(n,"svg","animation-ui"),this.#ge.setAttribute("height",U.AnimationSVGHeight.toString()),this.#ge.style.marginLeft="-"+U.AnimationMargin+"px",this.#ge.addEventListener("contextmenu",this.onContextMenu.bind(this)),this.#ve=e.UIUtils.createSVGChild(this.#ge,"g"),e.UIUtils.installDragHandle(this.#ve,this.mouseDown.bind(this,"AnimationDrag",null),this.mouseMove.bind(this),this.mouseUp.bind(this),"-webkit-grabbing","-webkit-grab"),D.installDragHandleKeyboard(this.#ve,this.keydownMove.bind(this,"AnimationDrag",null)),this.#we=[],this.#xe=0,this.#Me=50,this.#ke=D.colorForAnimation(this.#pe)}static colorForAnimation(e){const t=Array.from(F.keys()),i=t[a.StringUtilities.hashCode(e.name()||e.id())%t.length],n=F.get(i);if(!n)throw new Error("Unable to locate color");return n.asString("rgb")||""}static installDragHandleKeyboard(e,t){e.addEventListener("keydown",t,!1)}animation(){return this.#pe}get nameElement(){return this.#ye}get svg(){return this.#ge}setNode(e){this.#ue=e}createLine(t,i){const n=e.UIUtils.createSVGChild(t,"line",i);return n.setAttribute("x1",U.AnimationMargin.toString()),n.setAttribute("y1",U.AnimationHeight.toString()),n.setAttribute("y2",U.AnimationHeight.toString()),n.style.stroke=this.#ke,n}drawAnimationLine(e,t){const i=this.#we[e];i.animationLine||(i.animationLine=this.createLine(t,"animation-line")),i.animationLine&&i.animationLine.setAttribute("x2",(this.duration()*this.#fe.pixelMsRatio()+U.AnimationMargin).toFixed(2))}drawDelayLine(e){this.#Ae&&this.#Ie||(this.#Ae=this.createLine(e,"animation-delay-line"),this.#Ie=this.createLine(e,"animation-delay-line"));const t=this.#pe.source().fill();this.#Ae.classList.toggle("animation-fill","backwards"===t||"both"===t);const i=U.AnimationMargin;this.#Ae.setAttribute("x1",i.toString()),this.#Ae.setAttribute("x2",(this.delay()*this.#fe.pixelMsRatio()+i).toFixed(2));const n="forwards"===t||"both"===t;this.#Ie.classList.toggle("animation-fill",n);const a=Math.min(this.#fe.width(),(this.delay()+this.duration()*this.#pe.source().iterations())*this.#fe.pixelMsRatio());this.#Ie.style.transform="translateX("+a.toFixed(2)+"px)",this.#Ie.setAttribute("x1",i.toString()),this.#Ie.setAttribute("x2",n?(this.#fe.width()-a+i).toFixed(2):(this.#pe.source().endDelay()*this.#fe.pixelMsRatio()+i).toFixed(2))}drawPoint(t,i,n,a,s){if(this.#we[t].keyframePoints[a])return void this.#we[t].keyframePoints[a].setAttribute("cx",n.toFixed(2));const o=e.UIUtils.createSVGChild(i,"circle",a<=0?"animation-endpoint":"animation-keyframe-point");if(o.setAttribute("cx",n.toFixed(2)),o.setAttribute("cy",U.AnimationHeight.toString()),o.style.stroke=this.#ke,o.setAttribute("r",(U.AnimationMargin/2).toString()),o.tabIndex=0,e.ARIAUtils.setLabel(o,L(a<=0?B.animationEndpointSlider:B.animationKeyframeSlider)),a<=0&&(o.style.fill=this.#ke),this.#we[t].keyframePoints[a]=o,!s)return;let r;r=0===a?"StartEndpointMove":-1===a?"FinishEndpointMove":"KeyframeMove",e.UIUtils.installDragHandle(o,this.mouseDown.bind(this,r,a),this.mouseMove.bind(this),this.mouseUp.bind(this),"ew-resize"),D.installDragHandleKeyboard(o,this.keydownMove.bind(this,r,a))}renderKeyframe(t,i,n,a,o,r){function l(t,i,n){const a=e.UIUtils.createSVGChild(t,"line");a.setAttribute("x1",i.toString()),a.setAttribute("x2",i.toString()),a.setAttribute("y1",U.AnimationMargin.toString()),a.setAttribute("y2",U.AnimationHeight.toString()),a.style.stroke=n}const d=e.Geometry.CubicBezier.parse(r),h=this.#we[t].keyframeRender;if(!h[i]){const t=d?e.UIUtils.createSVGChild(n,"path","animation-keyframe"):e.UIUtils.createSVGChild(n,"g","animation-keyframe-step");h[i]=t}const c=h[i];if(c.tabIndex=0,e.ARIAUtils.setLabel(c,L(B.sSlider,{PH1:this.#pe.name()})),c.style.transform="translateX("+a.toFixed(2)+"px)","linear"===r){c.style.fill=this.#ke;const e=s.BezierUI.Height;c.setAttribute("d",["M",0,e,"L",0,5,"L",o.toFixed(2),5,"L",o.toFixed(2),e,"Z"].join(" "))}else if(d)c.style.fill=this.#ke,s.BezierUI.BezierUI.drawVelocityChart(d,c,o);else{const e=R.parse(r);c.removeChildren();if(e){const t={start:0,middle:.5,end:1}[e.stepAtPosition];for(let i=0;i<e.steps;i++)l(c,(i+t)*o/e.steps,this.#ke)}}}redraw(){const t=this.#fe.width()-U.AnimationMargin;if(this.#ge.setAttribute("width",(t+2*U.AnimationMargin).toFixed(2)),this.#ve.style.transform="translateX("+(this.delay()*this.#fe.pixelMsRatio()).toFixed(2)+"px)",this.#ye.style.transform="translateX("+(this.delay()*this.#fe.pixelMsRatio()+U.AnimationMargin).toFixed(2)+"px)",this.#ye.style.width=(this.duration()*this.#fe.pixelMsRatio()).toFixed(2)+"px",this.drawDelayLine(this.#ge),"CSSTransition"===this.#pe.type())return void this.renderTransition();this.renderIteration(this.#ve,0),this.#Te||(this.#Te=e.UIUtils.createSVGChild(this.#ve,"g","animation-tail-iterations"));const i=this.duration()*this.#fe.pixelMsRatio();let n;for(n=1;n<this.#pe.source().iterations()&&i*(n-1)<this.#fe.width()&&(i>0||this.#pe.source().iterations()!==1/0);n++)this.renderIteration(this.#Te,n);for(;n<this.#we.length;){const e=this.#we.pop();e&&e.group&&e.group.remove()}}renderTransition(){const e=this.#ve;this.#we[0]||(this.#we[0]={animationLine:null,keyframePoints:{},keyframeRender:{},group:null}),this.drawAnimationLine(0,e),this.renderKeyframe(0,0,e,U.AnimationMargin,this.duration()*this.#fe.pixelMsRatio(),this.#pe.source().easing()),this.drawPoint(0,e,U.AnimationMargin,0,!0),this.drawPoint(0,e,this.duration()*this.#fe.pixelMsRatio()+U.AnimationMargin,-1,!0)}renderIteration(t,i){this.#we[i]||(this.#we[i]={animationLine:null,keyframePoints:{},keyframeRender:{},group:e.UIUtils.createSVGChild(t,"g")});const n=this.#we[i].group;if(n){if(n.style.transform="translateX("+(i*this.duration()*this.#fe.pixelMsRatio()).toFixed(2)+"px)",this.drawAnimationLine(i,n),this.#be&&this.#be.length>1)for(let e=0;e<this.#be.length-1;e++){const t=this.offset(e)*this.duration()*this.#fe.pixelMsRatio()+U.AnimationMargin,a=this.duration()*(this.offset(e+1)-this.offset(e))*this.#fe.pixelMsRatio();this.renderKeyframe(i,e,n,t,a,this.#be[e].easing()),(e||!e&&0===i)&&this.drawPoint(i,n,t,e,0===i)}this.drawPoint(i,n,this.duration()*this.#fe.pixelMsRatio()+U.AnimationMargin,-1,0===i)}}delay(){let e=this.#pe.source().delay();return"AnimationDrag"!==this.#Ce&&"StartEndpointMove"!==this.#Ce||(e+=this.#xe),Math.max(0,e)}duration(){let e=this.#pe.source().duration();return"FinishEndpointMove"===this.#Ce?e+=this.#xe:"StartEndpointMove"===this.#Ce&&(e-=Math.max(this.#xe,-this.#pe.source().delay())),Math.max(0,e)}offset(e){if(!this.#be)throw new Error("Unable to calculate offset; keyframes do not exist");let t=this.#be[e].offsetAsNumber();return"KeyframeMove"===this.#Ce&&e===this.#Se&&(console.assert(e>0&&e<this.#be.length-1,"First and last keyframe cannot be moved"),t+=this.#xe/this.#pe.source().duration(),t=Math.max(t,this.#be[e-1].offsetAsNumber()),t=Math.min(t,this.#be[e+1].offsetAsNumber())),t}mouseDown(i,n,a){const s=a;if(2===s.buttons)return!1;if(this.#ge.enclosingNodeOrSelfWithClass("animation-node-removed"))return!1;this.#Ce=i,this.#Se=n,this.#Pe=s.clientX,a.consume(!0);const o=e.ViewManager.ViewManager.instance(),r=o.locationNameForViewId("animations"),l=o.locationNameForViewId("elements");return this.#ue&&r!==l&&t.Revealer.reveal(this.#ue),!0}mouseMove(e){const t=e;this.setMovementAndRedraw((t.clientX-(this.#Pe||0))/this.#fe.pixelMsRatio())}setMovementAndRedraw(e){this.#xe=e,this.delay()+this.duration()>.8*this.#fe.duration()&&this.#fe.setDuration(1.2*this.#fe.duration()),this.redraw()}mouseUp(e){const t=e;this.#xe=(t.clientX-(this.#Pe||0))/this.#fe.pixelMsRatio(),"KeyframeMove"===this.#Ce?this.#be&&null!==this.#Se&&void 0!==this.#Se&&this.#be[this.#Se].setOffset(this.offset(this.#Se)):this.#pe.setTiming(this.duration(),this.delay()),i.userMetrics.animationPointDragged("AnimationDrag"===this.#Ce?0:"KeyframeMove"===this.#Ce?1:"StartEndpointMove"===this.#Ce?2:"FinishEndpointMove"===this.#Ce?3:4),this.#xe=0,this.redraw(),this.#Ce=void 0,this.#Pe=void 0,this.#Se=void 0}keydownMove(e,t,i){const n=i;switch(this.#Ce=e,this.#Se=t,n.key){case"ArrowLeft":case"ArrowUp":this.#xe=-this.#Me;break;case"ArrowRight":case"ArrowDown":this.#xe=this.#Me;break;default:return}"KeyframeMove"===this.#Ce?this.#be&&null!==this.#Se&&this.#be[this.#Se].setOffset(this.offset(this.#Se)):this.#pe.setTiming(this.duration(),this.delay()),this.setMovementAndRedraw(0),this.#Ce=void 0,this.#Se=void 0,i.consume(!0)}onContextMenu(t){this.#pe.remoteObjectPromise().then((function(i){if(!i)return;const n=new e.ContextMenu.ContextMenu(t);n.appendApplicableItems(i),n.show()})),t.consume(!0)}}const U={AnimationHeight:26,AnimationSVGHeight:50,AnimationMargin:7,EndpointsClickRegionSize:10,GridCanvasHeight:40},F=new Map([["Purple",t.Color.parse("#9C27B0")],["Light Blue",t.Color.parse("#03A9F4")],["Deep Orange",t.Color.parse("#FF5722")],["Blue",t.Color.parse("#5677FC")],["Lime",t.Color.parse("#CDDC39")],["Blue Grey",t.Color.parse("#607D8B")],["Pink",t.Color.parse("#E91E63")],["Green",t.Color.parse("#0F9D58")],["Brown",t.Color.parse("#795548")],["Cyan",t.Color.parse("#00BCD4")]]);var N=Object.freeze({__proto__:null,AnimationUI:D,Options:U,Colors:F});class z{#Re;element;#Ee;#Be;#ge;#Ge;constructor(t){this.#Re=t,this.element=document.createElement("div"),this.element.classList.add("animation-buffer-preview"),this.element.createChild("div","animation-paused fill"),this.#Ee=this.element.createChild("div","animation-remove-button"),this.#Ee.textContent="✕",this.#Be=this.element.createChild("div","animation-buffer-preview-animation"),this.#ge=e.UIUtils.createSVGChild(this.element,"svg"),this.#ge.setAttribute("width","100%"),this.#ge.setAttribute("preserveAspectRatio","none"),this.#ge.setAttribute("height","100%"),this.#Ge=32,this.#ge.setAttribute("viewBox","0 0 100 "+this.#Ge),this.#ge.setAttribute("shape-rendering","crispEdges"),this.render()}groupDuration(){let e=0;for(const t of this.#Re.animations()){const i=t.source().delay()+t.source().duration();i>e&&(e=i)}return e}removeButton(){return this.#Ee}replay(){this.#Be.animate([{offset:0,width:"0%",opacity:1},{offset:.9,width:"100%",opacity:1},{offset:1,width:"100%",opacity:0}],{duration:200,easing:"cubic-bezier(0, 0, 0.2, 1)"})}render(){this.#ge.removeChildren();const t=Math.min(this.#Re.animations().length,10),i=100/Math.max(this.groupDuration(),750);for(let n=0;n<t;n++){const a=this.#Re.animations()[n].source(),s=e.UIUtils.createSVGChild(this.#ge,"line");s.setAttribute("x1",String(a.delay()*i)),s.setAttribute("x2",String((a.delay()+a.duration())*i));const o=String(Math.floor(this.#Ge/Math.max(6,t)*n+1));s.setAttribute("y1",o),s.setAttribute("y2",o),s.style.stroke=D.colorForAnimation(this.#Re.animations()[n])}}}var O=Object.freeze({__proto__:null,AnimationGroupPreviewUI:z});export{O as AnimationGroupPreviewUI,y as AnimationModel,w as AnimationScreenshotPopover,E as AnimationTimeline,N as AnimationUI};
