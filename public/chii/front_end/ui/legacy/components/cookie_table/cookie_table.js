import*as e from"../../../../core/common/common.js";import*as t from"../../../../core/i18n/i18n.js";import*as i from"../../../../core/platform/platform.js";import*as o from"../../../../core/root/root.js";import*as s from"../../../../core/sdk/sdk.js";import*as r from"../../../../models/issues_manager/issues_manager.js";import*as a from"../../../../panels/network/forward/forward.js";import*as l from"../../../components/icon_button/icon_button.js";import*as n from"../../legacy.js";import*as d from"../data_grid/data_grid.js";const u=new CSSStyleSheet;u.replaceSync(".cookies-table devtools-icon{margin-right:4px}.cookies-table td.flagged-cookie-attribute-cell devtools-icon{filter:grayscale()}.cookies-table:focus-within tr.flagged-cookie-attribute-row.selected devtools-icon{filter:brightness(0) invert(1)}.cookies-table tr.revealed.data-grid-data-grid-node.flagged-cookie-attribute-row:not(.selected):nth-child(odd){background-color:var(--sys-color-surface-yellow-high)}.cookies-table tr.revealed.data-grid-data-grid-node.flagged-cookie-attribute-row:not(.selected):nth-child(even){background-color:var(--sys-color-surface-yellow)}\n/*# sourceURL=cookiesTable.css */\n");const c={session:"Session",name:"Name",value:"Value",size:"Size",editableCookies:"Editable Cookies",cookies:"Cookies",na:"N/A",showRequestsWithThisCookie:"Show Requests With This Cookie",showIssueAssociatedWithThis:"Show issue associated with this cookie",sourcePortTooltip:"Shows the source port (range 1-65535) the cookie was set on. If the port is unknown, this shows -1.",sourceSchemeTooltip:"Shows the source scheme (`Secure`, `NonSecure`) the cookie was set on. If the scheme is unknown, this shows `Unset`.",timeAfter:"after {date}",timeAfterTooltip:"The expiration timestamp is {seconds}, which corresponds to a date after {date}",opaquePartitionKey:"(opaque)"},h=t.i18n.registerUIStrings("ui/legacy/components/cookie_table/CookiesTable.ts",c),k=t.i18n.getLocalizedString.bind(void 0,h),b=t.i18n.getLazilyComputedLocalizedString.bind(void 0,h)(c.session);class C extends n.Widget.VBox{saveCallback;refreshCallback;deleteCallback;dataGrid;lastEditedColumnId;data;cookieDomain;cookieToBlockedReasons;constructor(e,t,i,r,a){super(),this.element.classList.add("cookies-table"),this.saveCallback=t,this.refreshCallback=i,this.deleteCallback=a;const l=Boolean(t),n=[{id:s.Cookie.Attributes.Name,title:k(c.name),sortable:!0,disclosure:l,sort:d.DataGrid.Order.Ascending,longText:!0,weight:24,editable:l},{id:s.Cookie.Attributes.Value,title:k(c.value),sortable:!0,longText:!0,weight:34,editable:l},{id:s.Cookie.Attributes.Domain,title:"Domain",sortable:!0,weight:7,editable:l},{id:s.Cookie.Attributes.Path,title:"Path",sortable:!0,weight:7,editable:l},{id:s.Cookie.Attributes.Expires,title:"Expires / Max-Age",sortable:!0,weight:7,editable:l},{id:s.Cookie.Attributes.Size,title:k(c.size),sortable:!0,align:d.DataGrid.Align.Right,weight:7},{id:s.Cookie.Attributes.HttpOnly,title:"HttpOnly",sortable:!0,align:d.DataGrid.Align.Center,weight:7,dataType:d.DataGrid.DataType.Boolean,editable:l},{id:s.Cookie.Attributes.Secure,title:"Secure",sortable:!0,align:d.DataGrid.Align.Center,weight:7,dataType:d.DataGrid.DataType.Boolean,editable:l},{id:s.Cookie.Attributes.SameSite,title:"SameSite",sortable:!0,weight:7,editable:l},{id:s.Cookie.Attributes.PartitionKey,title:"Partition Key",sortable:!0,weight:7,editable:l},{id:s.Cookie.Attributes.Priority,title:"Priority",sortable:!0,weight:7,editable:l}];if(o.Runtime.experiments.isEnabled("experimentalCookieFeatures")){const e=[{id:s.Cookie.Attributes.SourceScheme,title:"SourceScheme",sortable:!0,align:d.DataGrid.Align.Center,weight:7,editable:l},{id:s.Cookie.Attributes.SourcePort,title:"SourcePort",sortable:!0,align:d.DataGrid.Align.Center,weight:7,editable:l}];n.push(...e)}this.dataGrid=l?new d.DataGrid.DataGridImpl({displayName:k(c.editableCookies),columns:n,editCallback:this.onUpdateCookie.bind(this),deleteCallback:this.onDeleteCookie.bind(this),refreshCallback:i}):new d.DataGrid.DataGridImpl({displayName:k(c.cookies),columns:n,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0}),this.dataGrid.setStriped(!0),this.dataGrid.setName("cookiesTable"),this.dataGrid.addEventListener(d.DataGrid.Events.SortingChanged,this.rebuildTable,this),this.dataGrid.setRowContextMenuCallback(this.populateContextMenu.bind(this)),e&&this.dataGrid.renderInline(),r&&this.dataGrid.addEventListener(d.DataGrid.Events.SelectedNode,r,this),this.lastEditedColumnId=null,this.dataGrid.asWidget().show(this.element),this.data=[],this.cookieDomain="",this.cookieToBlockedReasons=null}wasShown(){this.registerCSSFiles([u])}setCookies(e,t){this.setCookieFolders([{cookies:e,folderName:null}],t)}setCookieFolders(e,t){this.data=e,this.cookieToBlockedReasons=t||null,this.rebuildTable()}setCookieDomain(e){this.cookieDomain=e}selectedCookie(){const e=this.dataGrid.selectedNode;return e?e.cookie:null}getSelectionCookies(){const e=this.dataGrid.selectedNode,t=e&&e.traverseNextNode(!0),i=e&&e.traversePreviousNode(!0);return{current:e&&e.cookie,neighbor:t&&t.cookie||i&&i.cookie}}willHide(){this.lastEditedColumnId=null}findSelectedCookie(e,t){if(!t)return null;const i=e.current,o=t.find((e=>this.isSameCookie(e,i)));if(o)return o;const s=e.neighbor,r=t.find((e=>this.isSameCookie(e,s)));return r||null}isSameCookie(e,t){return null!=t&&t.name()===e.name()&&t.domain()===e.domain()&&t.path()===e.path()}rebuildTable(){const e=this.getSelectionCookies(),t=this.lastEditedColumnId;this.lastEditedColumnId=null,this.dataGrid.rootNode().removeChildren();for(let i=0;i<this.data.length;++i){const o=this.data[i],r=this.findSelectedCookie(e,o.cookies);if(o.folderName){const e={};e[s.Cookie.Attributes.Name]=o.folderName,e[s.Cookie.Attributes.Value]="",e[s.Cookie.Attributes.Size]=this.totalSize(o.cookies),e[s.Cookie.Attributes.Domain]="",e[s.Cookie.Attributes.Path]="",e[s.Cookie.Attributes.Expires]="",e[s.Cookie.Attributes.HttpOnly]="",e[s.Cookie.Attributes.Secure]="",e[s.Cookie.Attributes.SameSite]="",e[s.Cookie.Attributes.SourcePort]="",e[s.Cookie.Attributes.SourceScheme]="",e[s.Cookie.Attributes.Priority]="";const i=new d.DataGrid.DataGridNode(e);i.selectable=!0,this.dataGrid.rootNode().appendChild(i),i.element().classList.add("row-group"),this.populateNode(i,o.cookies,r,t),i.expand()}else this.populateNode(this.dataGrid.rootNode(),o.cookies,r,t)}e.current&&t&&!this.dataGrid.selectedNode&&this.addInactiveNode(this.dataGrid.rootNode(),e.current,t),this.saveCallback&&this.dataGrid.addCreationNode(!1)}populateNode(e,t,i,o){if(e.removeChildren(),t){this.sortCookies(t);for(let s=0;s<t.length;++s){const r=t[s],a=this.createGridNode(r);e.appendChild(a),this.isSameCookie(r,i)&&(a.select(),null!==o&&this.dataGrid.startEditingNextEditableColumnOfDataGridNode(a,o))}}}addInactiveNode(e,t,i){const o=this.createGridNode(t);e.appendChild(o),o.select(),o.setInactive(!0),null!==i&&this.dataGrid.startEditingNextEditableColumnOfDataGridNode(o,i)}totalSize(e){let t=0;for(let i=0;e&&i<e.length;++i)t+=e[i].size();return t}sortCookies(e){const t=this.dataGrid.isSortOrderAscending()?1:-1;function o(e,t){switch(t){case s.Cookie.Attributes.Name:return String(e.name());case s.Cookie.Attributes.Value:return String(e.value());case s.Cookie.Attributes.Domain:return String(e.domain());case s.Cookie.Attributes.Path:return String(e.path());case s.Cookie.Attributes.HttpOnly:return String(e.httpOnly());case s.Cookie.Attributes.Secure:return String(e.secure());case s.Cookie.Attributes.SameSite:return String(e.sameSite());case s.Cookie.Attributes.PartitionKey:return e.partitionKeyOpaque()?k(c.opaquePartitionKey):String(e.partitionKey());case s.Cookie.Attributes.SourceScheme:return String(e.sourceScheme());default:return String(e.name())}}function r(e,i,o){return t*(e(i)-e(o))}let a;const l=this.dataGrid.sortColumnId()||s.Cookie.Attributes.Name;a=l===s.Cookie.Attributes.Expires?function(e,i){return e.session()!==i.session()?t*(e.session()?1:-1):e.session()?0:e.maxAge()&&i.maxAge()?t*(e.maxAge()-i.maxAge()):e.expires()&&i.expires()?t*(e.expires()-i.expires()):t*(e.expires()?1:-1)}:l===s.Cookie.Attributes.Size?r.bind(null,(e=>e.size())):l===s.Cookie.Attributes.SourcePort?r.bind(null,(e=>e.sourcePort())):l===s.Cookie.Attributes.Priority?function(e,i){const o=["Low","Medium","High"],s=o.indexOf(e.priority()),r=o.indexOf(i.priority());return t*(s-r)}:function(e,s,r){return t*i.StringUtilities.compare(o(s,e),o(r,e))}.bind(null,l),e.sort(a)}createGridNode(e){const i={};let o;if(i[s.Cookie.Attributes.Name]=e.name(),i[s.Cookie.Attributes.Value]=e.value(),e.type()===s.Cookie.Type.Request?(i[s.Cookie.Attributes.Domain]=e.domain()?e.domain():k(c.na),i[s.Cookie.Attributes.Path]=e.path()?e.path():k(c.na)):(i[s.Cookie.Attributes.Domain]=e.domain()||"",i[s.Cookie.Attributes.Path]=e.path()||""),e.maxAge())i[s.Cookie.Attributes.Expires]=t.TimeUtilities.secondsToString(Math.floor(e.maxAge()));else if(e.expires()){const t=e.expires();if(t<0)i[s.Cookie.Attributes.Expires]=b();else{const e=864e13;if(t>e){const r=new Date(e).toISOString();i[s.Cookie.Attributes.Expires]=k(c.timeAfter,{date:r}),o=k(c.timeAfterTooltip,{seconds:t,date:r})}else i[s.Cookie.Attributes.Expires]=new Date(t).toISOString()}}else i[s.Cookie.Attributes.Expires]=e.type()===s.Cookie.Type.Request?k(c.na):b();i[s.Cookie.Attributes.Size]=e.size(),i[s.Cookie.Attributes.HttpOnly]=e.httpOnly(),i[s.Cookie.Attributes.Secure]=e.secure(),i[s.Cookie.Attributes.SameSite]=e.sameSite()||"",i[s.Cookie.Attributes.SourcePort]=e.sourcePort(),i[s.Cookie.Attributes.SourceScheme]=e.sourceScheme(),i[s.Cookie.Attributes.Priority]=e.priority()||"",i[s.Cookie.Attributes.PartitionKey]=e.partitionKey()||"";const r=this.cookieToBlockedReasons?.get(e),a=new m(i,e,r||null);return o&&a.setExpiresTooltip(o),a.selectable=!0,a}onDeleteCookie(e){e.cookie&&this.deleteCallback&&this.deleteCallback(e.cookie,(()=>this.refresh()))}onUpdateCookie(e,t,i,o){this.lastEditedColumnId=t,this.setDefaults(e),this.isValidCookieData(e.data)?this.saveNode(e):e.setDirty(!0)}setDefaults(e){null===e.data[s.Cookie.Attributes.Name]&&(e.data[s.Cookie.Attributes.Name]=""),null===e.data[s.Cookie.Attributes.Value]&&(e.data[s.Cookie.Attributes.Value]=""),null===e.data[s.Cookie.Attributes.Domain]&&(e.data[s.Cookie.Attributes.Domain]=this.cookieDomain),null===e.data[s.Cookie.Attributes.Path]&&(e.data[s.Cookie.Attributes.Path]="/"),null===e.data[s.Cookie.Attributes.Expires]&&(e.data[s.Cookie.Attributes.Expires]=b()),null===e.data[s.Cookie.Attributes.PartitionKey]&&(e.data[s.Cookie.Attributes.PartitionKey]="")}saveNode(e){const t=e.cookie,i=this.createCookieFromData(e.data);e.cookie=i,this.saveCallback&&this.saveCallback(i,t).then((t=>{t?this.refresh():e.setDirty(!0)}))}createCookieFromData(e){const t=new s.Cookie.Cookie(e[s.Cookie.Attributes.Name],e[s.Cookie.Attributes.Value],null,e[s.Cookie.Attributes.Priority]);return t.addAttribute(s.Cookie.Attributes.Domain,e[s.Cookie.Attributes.Domain]),t.addAttribute(s.Cookie.Attributes.Path,e[s.Cookie.Attributes.Path]),e.expires&&e.expires!==b()&&t.addAttribute(s.Cookie.Attributes.Expires,new Date(e[s.Cookie.Attributes.Expires]).toUTCString()),e[s.Cookie.Attributes.HttpOnly]&&t.addAttribute(s.Cookie.Attributes.HttpOnly),e[s.Cookie.Attributes.Secure]&&t.addAttribute(s.Cookie.Attributes.Secure),e[s.Cookie.Attributes.SameSite]&&t.addAttribute(s.Cookie.Attributes.SameSite,e[s.Cookie.Attributes.SameSite]),s.Cookie.Attributes.SourceScheme in e&&t.addAttribute(s.Cookie.Attributes.SourceScheme,e[s.Cookie.Attributes.SourceScheme]),s.Cookie.Attributes.SourcePort in e&&t.addAttribute(s.Cookie.Attributes.SourcePort,Number.parseInt(e[s.Cookie.Attributes.SourcePort],10)||void 0),e[s.Cookie.Attributes.PartitionKey]&&t.addAttribute(s.Cookie.Attributes.PartitionKey,e[s.Cookie.Attributes.PartitionKey]),t.setSize(e[s.Cookie.Attributes.Name].length+e[s.Cookie.Attributes.Value].length),t}isValidCookieData(e){return(Boolean(e.name)||Boolean(e.value))&&this.isValidDomain(e.domain)&&this.isValidPath(e.path)&&this.isValidDate(e.expires)}isValidDomain(t){if(!t)return!0;const i=e.ParsedURL.ParsedURL.fromString("http://"+t);return null!==i&&i.domain()===t}isValidPath(t){const i=e.ParsedURL.ParsedURL.fromString("http://example.com"+t);return null!==i&&i.path===t}isValidDate(e){return""===e||e===b()||!isNaN(Date.parse(e))}refresh(){this.refreshCallback&&this.refreshCallback()}populateContextMenu(t,i){const o=i.cookie;if(!o)return;const s=o;t.revealSection().appendItem(k(c.showRequestsWithThisCookie),(()=>{const t=a.UIFilter.UIRequestFilter.filters([{filterType:a.UIFilter.FilterType.CookieDomain,filterValue:s.domain()},{filterType:a.UIFilter.FilterType.CookieName,filterValue:s.name()}]);e.Revealer.reveal(t)})),r.RelatedIssue.hasIssues(s)&&t.revealSection().appendItem(k(c.showIssueAssociatedWithThis),(()=>{r.RelatedIssue.reveal(s)}))}}class m extends d.DataGrid.DataGridNode{cookie;blockedReasons;expiresTooltip;constructor(e,t,i){super(e),this.cookie=t,this.blockedReasons=i}createCells(e){super.createCells(e),this.blockedReasons&&this.blockedReasons.length&&e.classList.add("flagged-cookie-attribute-row")}setExpiresTooltip(e){this.expiresTooltip=e}createCell(e){const t=super.createCell(e);e===s.Cookie.Attributes.SourcePort?n.Tooltip.Tooltip.install(t,k(c.sourcePortTooltip)):e===s.Cookie.Attributes.SourceScheme?n.Tooltip.Tooltip.install(t,k(c.sourceSchemeTooltip)):e===s.Cookie.Attributes.Expires&&this.expiresTooltip?n.Tooltip.Tooltip.install(t,this.expiresTooltip):n.Tooltip.Tooltip.install(t,t.textContent||"");let i="";if(this.blockedReasons)for(const t of this.blockedReasons){const o=t.attribute===e,r=!t.attribute&&e===s.Cookie.Attributes.Name;(o||r)&&(i&&(i+="\n"),i+=t.uiString)}if(e===s.Cookie.Attributes.Name&&r.RelatedIssue.hasThirdPartyPhaseoutCookieIssue(this.cookie)){const e=new l.Icon.Icon;e.data={iconName:"warning-filled",color:"var(--icon-warning)",width:"14px",height:"14px"},e.onclick=()=>r.RelatedIssue.reveal(this.cookie),e.style.cursor="pointer",e.title=i,t.insertBefore(e,t.firstChild)}else if(i){const e=new l.Icon.Icon;e.data={iconName:"info",color:"var(--icon-info)",width:"14px",height:"14px"},t.classList.add("flagged-cookie-attribute-cell"),e.title=i,t.insertBefore(e,t.firstChild)}return t}}var p=Object.freeze({__proto__:null,CookiesTable:C,DataGridNode:m});export{p as CookiesTable};
