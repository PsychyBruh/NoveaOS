import*as e from"../../core/common/common.js";import*as t from"../../core/host/host.js";import{assertNotNullOrUndefined as n}from"../../core/platform/platform.js";import*as o from"../components/render_coordinator/render_coordinator.js";const r="jslog";function i(e){return e.hasAttribute(r)}function s(e){return a(e.getAttribute(r)||"")}var l;function a(e){const t=e.replace(/ /g,"").split(";"),n=e=>t.find((t=>t.startsWith(e)))?.substr(e.length),o=function(e){return l[e]??0}(t[0]);if(0===o)throw new Error("Unkown VE: "+e);const r={ve:o},i=n("context:");i&&(r.context=i);const s=n("parent:");s&&(r.parent=s);const a=n("track:");return a&&(r.track=new Map(a.split(",").map((e=>e.split(":"))))),r}function c(e){const t=[l[e.ve]];return e.context&&t.push(`context: ${e.context}`),e.parent&&t.push(`parent: ${e.parent}`),e.track?.size&&t.push(`track: ${[...e.track?.entries()].map((([e,t])=>`${e}${t?`: ${t}`:""}`)).join(", ")}`),t.join("; ")}function d(e){const t=[e];return{context:function(e){return void 0!==e&&t.push(`context: ${e}`),this},parent:function(e){return t.push(`parent: ${e}`),this},track:function(e){return t.push(`track: ${Object.entries(e).map((([e,t])=>!0!==t?`${e}: ${t}`:e)).join(", ")}`),this},toString:function(){return t.join("; ")}}}function u(e){const t=[],n=[],o=[],r=(e,t)=>{for(const n of e)o.push({element:n,parent:t})};for(const t of e)r(t.body.children);let s=0;for(;;){const e=o[s++];if(!e)break;const{element:l}=e;let{parent:a}=e;i(l)&&(t.push({element:l,parent:a}),a=l),r(l.children,a),l.shadowRoot&&(n.push(l.shadowRoot),r(l.shadowRoot.children,a))}return{loggables:t,shadowRoots:n}}!function(e){e[e.TreeItem=1]="TreeItem",e[e.Toggle=6]="Toggle",e[e.Tree=7]="Tree",e[e.TextField=8]="TextField",e[e.ShowAllStyleProperties=9]="ShowAllStyleProperties",e[e.Section=10]="Section",e[e.StylePropertiesSectionSeparator=11]="StylePropertiesSectionSeparator",e[e.StylesSelector=13]="StylesSelector",e[e.TreeItemExpand=14]="TreeItemExpand",e[e.ToggleSubpane=15]="ToggleSubpane",e[e.DropDown=20]="DropDown",e[e.JumpToSource=22]="JumpToSource",e[e.MetricsBox=23]="MetricsBox",e[e.MetricsBoxPart=24]="MetricsBoxPart",e[e.DOMBreakpoint=26]="DOMBreakpoint",e[e.Action=29]="Action",e[e.FilterDropdown=30]="FilterDropdown",e[e.InfoBar=31]="InfoBar",e[e.BezierCurveEditor=32]="BezierCurveEditor",e[e.BezierEditor=33]="BezierEditor",e[e.BezierPresetCategory=34]="BezierPresetCategory",e[e.Preview=35]="Preview",e[e.ColorCanvas=36]="ColorCanvas",e[e.ColorEyeDropper=37]="ColorEyeDropper",e[e.ColorPicker=38]="ColorPicker",e[e.CopyColor=39]="CopyColor",e[e.CssAngleEditor=40]="CssAngleEditor",e[e.CssFlexboxEditor=41]="CssFlexboxEditor",e[e.CssGridEditor=42]="CssGridEditor",e[e.CssShadowEditor=43]="CssShadowEditor",e[e.Link=44]="Link",e[e.Next=45]="Next",e[e.Item=46]="Item",e[e.PaletteColorShades=47]="PaletteColorShades",e[e.Panel=48]="Panel",e[e.Previous=49]="Previous",e[e.ShowStyleEditor=50]="ShowStyleEditor",e[e.Slider=51]="Slider",e[e.CssColorMix=52]="CssColorMix",e[e.Value=53]="Value",e[e.Key=54]="Key",e[e.GridSettings=55]="GridSettings",e[e.FlexboxOverlays=56]="FlexboxOverlays",e[e.GridOverlays=57]="GridOverlays",e[e.JumpToElement=58]="JumpToElement",e[e.PieChart=59]="PieChart",e[e.PieChartSlice=60]="PieChartSlice",e[e.PieChartTotal=61]="PieChartTotal",e[e.ElementsBreadcrumbs=62]="ElementsBreadcrumbs",e[e.PanelTabHeader=66]="PanelTabHeader",e[e.Menu=67]="Menu",e[e.TableHeader=69]="TableHeader",e[e.TableCell=70]="TableCell",e[e.StylesComputedPane=71]="StylesComputedPane",e[e.Pane=72]="Pane",e[e.ResponsivePresets=73]="ResponsivePresets",e[e.DeviceModeRuler=74]="DeviceModeRuler",e[e.MediaInspectorView=75]="MediaInspectorView"}(l||(l={}));const p=10;function b(e,t){const n=function(e,t){const n=Math.max(e.left,t.left),o=Math.min(e.left+e.width,t.left+t.width);if(n<=o){const r=Math.max(e.top,t.top),i=Math.min(e.top+e.height,t.top+t.height);if(r<=i)return new DOMRect(n,r,o-n,i-r)}return null}(t,e.getBoundingClientRect());return Boolean(n&&n.width>=p&&n.height>=p)}const h=new WeakMap;function g(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}function f(e,t,n){if(h.has(e))return h.get(e);t.parent&&C.has(t.parent)&&e instanceof Element&&(n=C.get(t.parent)?.(e));const o={impressionLogged:!1,processed:!1,config:t,context:y(t.context),veid:g(),parent:n?m(n):null};return h.set(e,o),o}function m(e){return h.get(e)||null}const v=new Map;function w(e,t){if(v.has(e))throw new Error(`Context provider with the name '${e} is already registered'`);v.set(e,t)}const y=e=>{if(!e)return()=>Promise.resolve(void 0);const t=v.get(e);if(t)return t;const n=parseInt(e,10);if(!isNaN(n))return()=>Promise.resolve(n);const o=(new TextEncoder).encode(e),r=crypto.subtle?crypto.subtle.digest("SHA-1",o).then((e=>new DataView(e).getUint32(0,!0))):Promise.resolve(3735928559);return()=>r},C=new Map;function x(e,t){if(C.has(e))throw new Error(`Parent provider with the name '${e} is already registered'`);C.set(e,t)}async function E(e){const o=await Promise.all(e.map((async e=>{const t=m(e);n(t);const o={id:t.veid,type:t.config.ve};t.parent&&(o.parent=t.parent.veid);const r=await t.context(e);return r&&(o.context=r),o})));o.length&&t.InspectorFrontendHost.InspectorFrontendHostInstance.recordImpression({impressions:o})}async function S(e,n,o){if(!(n instanceof MouseEvent))return;const r=m(e);if(!r)return;const i={veid:r.veid,mouseButton:n.button,doubleClick:Boolean(o?.doubleClick)},s=await r.context(n);s&&(i.context=s),t.InspectorFrontendHost.InspectorFrontendHostInstance.recordClick(i)}const T=e=>async o=>{const r=m(o.currentTarget);n(r);const i={veid:r.veid},s=r.context(o);await e.schedule((async()=>{const e=await s;e&&(i.context=e),t.InspectorFrontendHost.InspectorFrontendHostInstance.recordHover(i)}))},P=e=>async o=>{const r=m(o.currentTarget);n(r);const i={veid:r.veid},s=r.context(o);await e.schedule((async()=>{const e=await s;e&&(i.context=e),t.InspectorFrontendHost.InspectorFrontendHostInstance.recordDrag(i)}))};async function k(e){const o=m(e.currentTarget);n(o);const r={veid:o.veid},i=await o.context(e);i&&(r.context=i),t.InspectorFrontendHost.InspectorFrontendHostInstance.recordChange(r)}const M=(e,o)=>async r=>{if(!(r instanceof KeyboardEvent))return;if(e.length&&!e.includes(r.code))return;const i=m(r.currentTarget);n(i);const s={veid:i.veid},l=await i.context(r);l&&(s.context=l),await o.schedule((async()=>{t.InspectorFrontendHost.InspectorFrontendHostInstance.recordKeyDown(s)}))},I=new Map;function L(e){I.delete(e)}let D,B,F,H;const R=new WeakMap,A=[];function O(e){for(const t of e)if(!R.has(t)){const e=new MutationObserver(G);e.observe(t,{attributes:!0,childList:!0,subtree:!0}),R.set(t,e)}}let $=!1;async function V(t){$=!0,D=t?.processingThrottler||new e.Throttler.Throttler(500),B=t?.keyboardLogThrottler||new e.Throttler.Throttler(3e3),F=t?.hoverLogThrottler||new e.Throttler.Throttler(1e3),H=t?.dragLogThrottler||new e.Throttler.Throttler(500),await j(document)}async function j(e){A.push(e),["interactive","complete"].includes(e.readyState)&&await N(),e.addEventListener("visibilitychange",G),e.addEventListener("scroll",G),O([e.body])}function z(){$=!1,I.clear();for(const e of A)e.removeEventListener("visibilitychange",G),e.removeEventListener("scroll",G),R.get(e.body)?.disconnect(),R.delete(e.body);const{shadowRoots:e}=u(A);for(const t of e)R.get(t)?.disconnect(),R.delete(t);A.length=0,D=null}function G(){D&&D.schedule((()=>o.RenderCoordinator.RenderCoordinator.instance().read("processForLogging",N)))}let J=!1,K=null;async function N(){if(document.hidden)return;const e=performance.now(),{loggables:o,shadowRoots:r}=u(A),i=[],l=new Map;O(r);const a=e=>{const t=e.ownerDocument,n=l.get(t)||new DOMRect(0,0,t.defaultView?.innerWidth||0,t.defaultView?.innerHeight||0);return l.set(t,n),n};for(const{element:e,parent:t}of o){const o=f(e,s(e),t);if(o.impressionLogged||b(e,a(e))&&(i.push(e),o.impressionLogged=!0),!o.processed){o.config.track?.has("click")&&e.addEventListener("click",(e=>S(e.currentTarget,e)),{capture:!0}),o.config.track?.has("dblclick")&&e.addEventListener("dblclick",(e=>S(e.currentTarget,e,{doubleClick:!0})),{capture:!0});const t=o.config.track?.has("hover");if(t){e.addEventListener("mouseover",T(F),{capture:!0});const t=()=>Promise.resolve();e.addEventListener("mouseout",(()=>F.schedule(t)),{capture:!0})}const n=o.config.track?.has("drag");if(n){e.addEventListener("pointerdown",P(H),{capture:!0});const t=()=>Promise.resolve();e.addEventListener("pointerup",(()=>H.schedule(t)),{capture:!0})}o.config.track?.has("change")&&e.addEventListener("change",k,{capture:!0});const r=o.config.track?.has("keydown"),i=o.config.track?.get("keydown")?.split(",")||[];r&&e.addEventListener("keydown",M(i,B),{capture:!0}),o.processed=!0}J&&!o.processedForDebugging&&(e.style.outline="solid 1px red",e.addEventListener("mouseenter",(()=>{n(K),K.style.display="block";const e=[o];let t=o.parent;for(;t;)e.push(t),t=t.parent;K.innerHTML=e.map((e=>c(e.config))).join("<br>")}),{capture:!0}),e.addEventListener("mouseleave",(()=>{n(K),K.style.display="none"}),{capture:!0}),o.processedForDebugging=!0)}for(const{loggable:e,config:t,parent:n}of[...I.values()]){const o=f(e,t,n);(!o.parent||o.parent.impressionLogged)&&(i.push(e),o.impressionLogged=!0,L(e))}await E(i),t.userMetrics.visualLoggingProcessingDone(performance.now()-e)}function W(e,t,n){$&&(!function(e,t,n){I.set(e,{loggable:e,config:t,parent:n})}(e,a(t),n||void 0),G())}globalThis.setVeDebuggingEnabled=function(e){J=e,e&&!K&&(K=document.createElement("div"),K.style.position="absolute",K.style.bottom="100px",K.style.left="100px",K.style.background="black",K.style.color="white",K.style.zIndex="100000",document.body.appendChild(K))};const U=d.bind(null,"Action"),_=d.bind(null,"BezierCurveEditor"),q=d.bind(null,"BezierEditor"),Q=d.bind(null,"BezierPresetCategory"),X=d.bind(null,"ColorCanvas"),Y=d.bind(null,"ColorEyeDropper"),Z=d.bind(null,"ColorPicker"),ee=d.bind(null,"CopyColor"),te=d.bind(null,"CssAngleEditor"),ne=d.bind(null,"CssColorMix"),oe=d.bind(null,"CssFlexboxEditor"),re=d.bind(null,"CssGridEditor"),ie=d.bind(null,"CssShadowEditor"),se=d.bind(null,"DeviceModeRuler"),le=d.bind(null,"DOMBreakpoint"),ae=d.bind(null,"DropDown"),ce=d.bind(null,"ElementsBreadcrumbs"),de=d.bind(null,"FilterDropdown"),ue=d.bind(null,"InfoBar"),pe=d.bind(null,"FlexboxOverlays"),be=d.bind(null,"GridOverlays"),he=d.bind(null,"GridSettings"),ge=d.bind(null,"Item"),fe=d.bind(null,"JumpToElement"),me=d.bind(null,"JumpToSource"),ve=d.bind(null,"Key"),we=d.bind(null,"Link"),ye=d.bind(null,"MediaInspectorView"),Ce=d.bind(null,"Menu"),xe=d.bind(null,"MetricsBox"),Ee=d.bind(null,"Next"),Se=d.bind(null,"PaletteColorShades"),Te=d.bind(null,"Pane"),Pe=d.bind(null,"Panel"),ke=d.bind(null,"PanelTabHeader"),Me=d.bind(null,"PieChart"),Ie=d.bind(null,"PieChartSlice"),Le=d.bind(null,"PieChartTotal"),De=d.bind(null,"Preview"),Be=d.bind(null,"Previous"),Fe=d.bind(null,"ResponsivePresets"),He=d.bind(null,"ShowAllStyleProperties"),Re=d.bind(null,"ShowStyleEditor"),Ae=d.bind(null,"Slider"),Oe=d.bind(null,"StylesComputedPane"),$e=d.bind(null,"Section"),Ve=d.bind(null,"StylePropertiesSectionSeparator"),je=d.bind(null,"StylesSelector"),ze=d.bind(null,"TableCell"),Ge=d.bind(null,"TableHeader"),Je=d.bind(null,"TextField"),Ke=d.bind(null,"Toggle"),Ne=d.bind(null,"ToggleSubpane"),We=d.bind(null,"Tree"),Ue=d.bind(null,"TreeItem"),_e=d.bind(null,"TreeItemExpand"),qe=d.bind(null,"Value");export{U as action,j as addDocument,_ as bezierCurveEditor,q as bezierEditor,Q as bezierPresetCategory,X as colorCanvas,Y as colorEyeDropper,Z as colorPicker,ee as copyColor,te as cssAngleEditor,ne as cssColorMix,oe as cssFlexboxEditor,re as cssGridEditor,ie as cssShadowEditor,se as deviceModeRuler,le as domBreakpoint,ae as dropDown,ce as elementsBreadcrumbs,de as filterDropdown,pe as flexboxOverlays,be as gridOverlays,he as gridSettings,ue as infoBar,ge as item,fe as jumpToElement,me as jumpToSource,ve as key,we as link,S as logClick,E as logImpressions,ye as mediaInspectorView,Ce as menu,xe as metricsBox,Ee as next,Se as paletteColorShades,Te as pane,Pe as panel,ke as panelTabHeader,Me as pieChart,Ie as pieChartSlice,Le as pieChartTotal,De as preview,Be as previous,w as registerContextProvider,W as registerLoggable,x as registerParentProvider,Fe as responsivePresets,$e as section,He as showAllStyleProperties,Re as showStyleEditor,Ae as slider,V as startLogging,z as stopLogging,Ve as stylePropertiesSectionSeparator,Oe as stylesComputedPane,je as stylesSelector,ze as tableCell,Ge as tableHeader,Je as textField,Ke as toggle,Ne as toggleSubpane,We as tree,Ue as treeItem,_e as treeItemExpand,qe as value};
