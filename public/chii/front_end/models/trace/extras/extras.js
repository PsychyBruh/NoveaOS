import*as e from"../../../core/sdk/sdk.js";import*as t from"../../../core/platform/platform.js";import*as n from"../helpers/helpers.js";import*as r from"../types/types.js";const a=new Map,o=new Map;async function i(t,n){const r=a.get(t)?.get(n);if(void 0!==r)return r;const o=e.TargetManager.TargetManager.instance().primaryPageTarget(),i=o?.model(e.DOMModel.DOMModel);if(!i)return null;const s=await i.pushNodesByBackendIdsToFrontend(new Set([n])),c=s?.get(n)||null,l=a.get(t)||new Map;return l.set(n,c),a.set(t,l),c}const s=new Map,c=new Map;var l=Object.freeze({__proto__:null,_TEST_clearCache:function(){a.clear(),o.clear(),s.clear(),c.clear()},domNodeForBackendNodeID:i,domNodesForMultipleBackendNodeIds:async function(t,n){const r=o.get(t)?.get(n);if(r)return r;const a=e.TargetManager.TargetManager.instance().primaryPageTarget(),i=a?.model(e.DOMModel.DOMModel);if(!i)return new Map;const s=await i.pushNodesByBackendIdsToFrontend(n)||new Map,c=o.get(t)||new Map;return c.set(n,s),o.set(t,c),s},sourcesForLayoutShift:async function(e,t){const n=s.get(e)?.get(t);if(n)return n;const r=t.args.data?.impacted_nodes;if(!r)return[];const a=[];await Promise.all(r.map((async t=>{const n=await i(e,t.node_id);n&&a.push({previousRect:new DOMRect(t.old_rect[0],t.old_rect[1],t.old_rect[2],t.old_rect[3]),currentRect:new DOMRect(t.new_rect[0],t.new_rect[1],t.new_rect[2],t.new_rect[3]),node:n})})));const o=s.get(e)||new Map;return o.set(t,a),s.set(e,o),a},normalizedImpactedNodesForLayoutShift:async function(t,n){const r=c.get(t)?.get(n);if(r)return r;const a=n.args?.data?.impacted_nodes;if(!a)return[];let o=null;const i=e.TargetManager.TargetManager.instance().primaryPageTarget(),s=await(i?.runtimeAgent().invoke_evaluate({expression:"window.devicePixelRatio"}));if("number"===s?.result.type&&(o=s?.result.value??null),!o)return a;const l=[];for(const e of a){const t={...e};for(let n=0;n<e.old_rect.length;n++)t.old_rect[n]/=o;for(let n=0;n<e.new_rect.length;n++)t.new_rect[n]/=o;l.push(t)}const g=c.get(t)||new Map;return g.set(n,l),c.set(t,g),l}});const g=new Map;var d=Object.freeze({__proto__:null,fromTraceData:function(e,n){const r=[],a=void 0!==n?n:e.Meta.traceBounds.min,o=e.Meta.traceBounds.range,i=g.get(e)?.get(a);if(i)return i;for(const t of e.Screenshots){if(t.ts<a)continue;const e={index:r.length,screenshotEvent:t,screenshotAsString:t.args.snapshot};r.push(e)}const s={zeroTime:a,spanTime:o,frames:Array.from(r)};return t.MapUtilities.getWithDefault(g,e,(()=>new Map)).set(a,s),s},frameClosestToTimestamp:function(e,n){const r=t.ArrayUtilities.nearestIndexFromEnd(e.frames,(e=>e.screenshotEvent.ts<n));return null===r?null:e.frames[r]}});const u=new Set(["(program)","(idle)","(root)"]);var m=Object.freeze({__proto__:null,calculateWindow:function(e,t){if(!t.length)return e;const a=t.filter((e=>!(r.TraceEvents.isProfileCall(e)&&(u.has(e.callFrame.functionName)||!e.callFrame.functionName))));if(0===a.length)return e;function o(e,t){let r=e;const o=a[r],i=n.Timing.eventTimingsMicroSeconds(o);let s=(i.startTime+i.endTime)/2,c=0;const l=Math.sign(t-e);for(let o=e;o!==t;o+=l){const e=a[o],t=n.Timing.eventTimingsMicroSeconds(e),i=(t.startTime+t.endTime)/2;c<.1*Math.abs(s-i)&&(r=o,s=i,c=0),c+=t.duration}return r}const i=o(a.length-1,0),s=o(0,i),c=n.Timing.eventTimingsMicroSeconds(a[s]),l=n.Timing.eventTimingsMicroSeconds(a[i]);let g=c.startTime,d=l.endTime;const m=d-g;return m<.1*e.range?e:(g=r.Timing.MicroSeconds(Math.max(g-.05*m,e.min)),d=r.Timing.MicroSeconds(Math.min(d+.05*m,e.max)),{min:g,max:d,range:r.Timing.MicroSeconds(d-g)})}});var f=Object.freeze({__proto__:null,forNewRecording:async function(t){try{const n=e.CPUThrottlingManager.CPUThrottlingManager.instance().hasPrimaryPageTargetSet()?await Promise.race([e.CPUThrottlingManager.CPUThrottlingManager.instance().getHardwareConcurrency(),new Promise((e=>{setTimeout((()=>e(void 0)),1e3)}))]):void 0,r=e.CPUThrottlingManager.CPUThrottlingManager.instance().cpuThrottlingRate(),a=e.NetworkManager.MultitargetNetworkManager.instance().networkConditions(),o="function"==typeof a.title?a.title():a.title;return{source:"DevTools",startTime:t?new Date(t).toJSON():void 0,cpuThrottling:r,networkThrottling:o,hardwareConcurrency:n}}catch{return{}}}});export{l as FetchNodes,d as FilmStrip,m as MainThreadActivity,f as Metadata};
